{% extends 'base.html' %}
{% load static %}

{% block content %}

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<style>
    /* Invoice Chupa Rahega */
    #printable-invoice {
        display: none; 
        background: white; width: 800px; padding: 40px; color: #000;
    }
    /* Button Style */
    .btn-download {
        background-color: #2C2C2C; color: #D4AF37; border: 1px solid #D4AF37;
        padding: 12px 30px; border-radius: 50px; cursor: pointer; font-weight: bold;
    }
    .btn-download:hover { background-color: #D4AF37; color: black; }
    
    /* Invoice Styles */
    .invoice-header { display: flex; justify-content: space-between; border-bottom: 2px solid #D4AF37; padding-bottom: 20px; }
    .invoice-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    .invoice-table th, .invoice-table td { padding: 10px; border-bottom: 1px solid #eee; }
</style>

<div class="row" style="margin-top: 50px;">
    <div class="col s12 m6 offset-m3">
        <div class="card z-depth-3" style="border-radius: 15px; padding: 20px;">
            <div class="center-align">
                <h4 style="color: #D4AF37;">Order #{{ order.id }}</h4>
                <p>Status: {{ order.status }}</p>
                <div class="divider" style="margin: 20px 0;"></div>
                
                <a href="https://wa.me/918421857457?text=Order%20%23{{ order.id }}" target="_blank" class="btn" style="background-color: #25D366; border-radius: 50px; margin-bottom: 10px;">
                    <i class="fab fa-whatsapp"></i> WhatsApp Owner
                </a>
                <br>
                <button onclick="downloadInvoice()" class="btn-download">
                    <i class="fas fa-file-download"></i> SAVE INVOICE PDF
                </button>
            </div>
        </div>
    </div>
</div>

<div id="printable-invoice">
    <div class="invoice-header">
        <div>
            <h2 style="color: #D4AF37; margin:0;">A1 Bakery</h2>
            <p>Malegaon, Maharashtra</p>
        </div>
        <div style="text-align: right;">
            <h3>INVOICE</h3>
            <p>Order #{{ order.id }}</p>
            <p>Date: {% now "d M Y" %}</p>
        </div>
    </div>
    
    <div style="margin-top: 20px;">
        <strong>Bill To:</strong><br>
        {{ order.customer_name }}<br>
        {{ order.customer_phone }}<br>
        {{ order.address }}
    </div>

    <table class="invoice-table">
        <tr>
            <th>Item</th><th>Qty</th><th>Price</th><th>Total</th>
        </tr>
        <tr>
            <td>{{ order.product.name }}</td>
            <td>{{ order.quantity }}</td>
            <td>₹{{ order.product.price }}</td>
            <td>₹{% widthratio order.product.price 1 order.quantity %}</td>
        </tr>
        <tr>
            <td></td><td></td>
            <td><strong>Total:</strong></td>
            <td><strong>₹{% widthratio order.product.price 1 order.quantity %}</strong></td>
        </tr>
    </table>
    
    <div style="margin-top: 40px; text-align: center; color: #777;">
        <p>Authorized Signatory - A1 Bakery</p>
    </div>
</div>

<script>
    function downloadInvoice() {
        const element = document.getElementById('printable-invoice');
        
        // 1. Invoice ko visible karo taaki PDF blank na aaye
        element.style.display = 'block';

        const opt = {
            margin: 0.5,
            filename: 'A1_Invoice_{{ order.id }}.pdf',
            image: { type: 'jpeg', quality: 0.98 },
            html2canvas: { scale: 2 },
            jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' }
        };

        // 2. Save karo aur wapas chupa do
        html2pdf().set(opt).from(element).save().then(function(){
            element.style.display = 'none';
        });
    }
</script>

{% endblock %}
