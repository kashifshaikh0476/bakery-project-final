{% extends 'base.html' %}
{% load static %}

{% block content %}

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<style>
    .whatsapp-btn-royal {
        background-color: #25D366 !important; color: #ffffff !important; font-weight: 700;
        border-radius: 50px; padding: 12px 35px; display: inline-flex; align-items: center; justify-content: center;
        text-transform: none; box-shadow: 0 5px 15px rgba(37, 211, 102, 0.4); transition: all 0.3s ease;
        margin-bottom: 15px; font-family: 'Poppins', sans-serif; letter-spacing: 0.5px; width: 100%; max-width: 300px;
    }
    .whatsapp-btn-royal:hover {
        background-color: #1ebc57 !important; box-shadow: 0 8px 20px rgba(37, 211, 102, 0.6); transform: translateY(-3px);
    }
    .whatsapp-btn-royal i { margin-right: 12px; font-size: 1.4rem; }
    
    .card-action-center { text-align: center; display: flex; flex-direction: column; align-items: center; }
    .other-links { margin-top: 15px; display: flex; gap: 20px; font-weight: 600; }

    .print-btn-royal {
        background-color: #2C2C2C !important; color: #D4AF37 !important; font-weight: 700; border: 1px solid #D4AF37;
        border-radius: 50px; padding: 10px 30px; display: inline-flex; align-items: center; justify-content: center;
        box-shadow: 0 5px 15px rgba(0,0,0,0.2); margin-bottom: 10px; width: 100%; max-width: 300px; cursor: pointer;
        font-family: 'Poppins', sans-serif; transition: 0.3s;
    }
    .print-btn-royal:hover { background-color: #D4AF37 !important; color: #000 !important; transform: translateY(-2px); }

    /* Screen par Bill ko chupa ke rakhenge */
    #printable-invoice { 
        position: absolute;
        left: -9999px;
        top: -9999px;
        background: white;
    }

    .invoice-box {
        width: 800px; padding: 30px; border: 1px solid #eee; background: white;
        font-size: 16px; line-height: 24px; font-family: 'Helvetica', Arial, sans-serif; color: #555;
    }
    .invoice-header { display: flex; justify-content: space-between; border-bottom: 2px solid #D4AF37; padding-bottom: 20px; margin-bottom: 20px; }
    .company-title { font-size: 40px; color: #D4AF37; font-weight: bold; }
    .invoice-table { width: 100%; line-height: inherit; text-align: left; border-collapse: collapse; }
    .invoice-table td { padding: 10px; vertical-align: top; }
    .invoice-table tr.heading td { background: #eee; border-bottom: 1px solid #ddd; font-weight: bold; }
    .invoice-table tr.item td { border-bottom: 1px solid #eee; }
    .invoice-table tr.total td { border-top: 2px solid #eee; font-weight: bold; font-size: 1.2rem; color: #D4AF37; }
</style>

<div class='header-h1'>
  <h1 style="font-family: 'Playfair Display', serif; color: #D4AF37; text-align: center;">Order Details</h1>
</div>

<div class="row">
  <div class="col s12 m6 offset-m3"> 
    <div class="card z-depth-3" style="border-radius: 20px; border: 1px solid #eee;">
      <div class="card-content" style="padding: 30px;">
        <span class="card-title" style="color: #D4AF37; font-weight: bold; text-align: center; font-family: 'Playfair Display', serif; font-size: 2rem;">
            {% if order.product %}
                {{ order.product.name }}
                <br>
                <span style="font-size: 1rem; color: #777; font-family: 'Poppins', sans-serif;">(Quantity: {{ order.quantity }})</span>
            {% else %}
                Unknown Item
            {% endif %}
        </span>
        
        <div class="divider" style="margin: 20px 0; background-color: #D4AF37;"></div>

        <div style="font-family: 'Poppins', sans-serif; color: #444; font-size: 1.1rem;">
            <p style="margin-bottom: 10px;"><i class="fas fa-user" style="color: #D4AF37; margin-right: 10px;"></i> <strong>{{ order.customer_name }}</strong></p>
            <p style="margin-bottom: 10px;"><i class="fas fa-envelope" style="color: #D4AF37; margin-right: 10px;"></i> {{ order.customer_email }}</p>     
            <p style="margin-bottom: 10px;"><i class="fas fa-phone" style="color: #D4AF37; margin-right: 10px;"></i> {{ order.customer_phone }}</p>
            
            <div style="margin-top: 20px; background: #fffcf0; padding: 15px; border-radius: 10px; border: 1px dashed #D4AF37;">
                <p style="margin-bottom: 5px;"><i class="fas fa-map-marker-alt" style="color: #D4AF37; margin-right: 10px;"></i> <strong>Address:</strong></p>
                <p style="margin-left: 30px;">{{ order.address }}</p>
                <p style="margin-left: 30px; margin-top: 5px;"><strong>City:</strong> {{ order.city }}</p>
            </div>
        </div>
        
        <div style="margin-top: 25px; text-align: center;">
            <span class="new badge" style="float: none; padding: 8px 20px; font-size: 1rem; border-radius: 50px; background-color: #2C2C2C;" data-badge-caption="">
                Status: {{ order.status }}
            </span>
        </div>
      </div>

      <div class="card-action card-action-center" style="padding-bottom: 30px; border-top: none;">
          
          <a id="whatsappBtn" 
             href="https://wa.me/918421857457?text=Hello%20A1%20Bakery,%20I%20placed%20a%20new%20order!%0A%0A*Order%20ID:*%20%23{{ order.id }}%0A*Item:*%20{{ order.product.name }}%20(x{{ order.quantity }})%0A*Customer:*%20{{ order.customer_name }}%0A*Address:*%20{{ order.address }}%0A*Status:*%20{{ order.status }}" 
             target="_blank" 
             class="whatsapp-btn-royal waves-effect waves-light">
             <i class="fab fa-whatsapp"></i> Send Order to Owner
          </a>

          <button onclick="downloadInvoice()" class="print-btn-royal waves-effect waves-dark">
             <i class="fas fa-file-download" style="margin-right: 10px;"></i> Download Invoice
          </button>

          <div class="other-links">
              <a href="{% url 'shop' %}" style="color: #D4AF37;">
                  <i class="fas fa-shopping-bag"></i> Shop Again
              </a>
              <a onclick="return confirm('Are you sure you want to delete this order?')" href="{% url 'delete_order' order.id %}" style="color: #d32f2f;">
                  <i class="fas fa-trash"></i> Delete
              </a>
          </div>
      </div>
    </div>
  </div>
</div>

<div id="printable-invoice">
    <div class="invoice-box">
        <div class="invoice-header">
            <div>
                <div class="company-title">A1 Bakery</div>
                <div>Malegaon, Maharashtra</div>
                <div>Phone: +91 8421857457</div>
            </div>
            <div style="text-align: right;">
                <h3 style="margin: 0; color: #333;">INVOICE</h3>
                <div>Order #: <strong>{{ order.id }}</strong></div>
                <div>Date: {% now "jS F Y" %}</div>
            </div>
        </div>

        <div style="margin-bottom: 20px;">
            <strong>Bill To:</strong><br>
            {{ order.customer_name }}<br>
            {{ order.customer_phone }}<br>
            {{ order.address }}, {{ order.city }}
        </div>

        <table class="invoice-table">
            <tr class="heading">
                <td>Item Description</td>
                <td style="text-align: center;">Qty</td>
                <td style="text-align: right;">Price</td>
                <td style="text-align: right;">Total</td>
            </tr>
            <tr class="item">
                <td>{{ order.product.name }}</td>
                <td style="text-align: center;">{{ order.quantity }}</td>
                <td style="text-align: right;">₹{{ order.product.price }}</td>
                <td style="text-align: right;">₹{% widthratio order.product.price 1 order.quantity %}</td>
            </tr>
            <tr class="total">
                <td></td><td></td>
                <td style="text-align: right;">Total Amount:</td>
                <td style="text-align: right;">₹{% widthratio order.product.price 1 order.quantity %}</td>
            </tr>
        </table>

        <div style="margin-top: 40px; text-align: center; font-size: 0.9rem; color: #777; border-top: 1px solid #eee; padding-top: 20px;">
            <p>Thank you for choosing A1 Bakery!</p>
            <div style="margin-top: 30px; text-align: right; font-weight: bold; color: #000;">
                Authorized Signatory<br>
                <span style="font-family: 'Playfair Display', serif; color: #D4AF37;">A1 Bakery</span>
            </div>
        </div>
    </div>
</div>

<script>
  // Direct Download Function
  function downloadInvoice() {
    const element = document.getElementById('printable-invoice');
    
    // Check if library is ready
    if (typeof html2pdf === 'undefined') {
        alert("Library is still loading. Please try again in 2 seconds.");
        return;
    }

    const options = {
      margin: 0.3,
      filename: 'A1_Bakery_Invoice_{{ order.id }}.pdf',
      image: { type: 'jpeg', quality: 0.98 },
      html2canvas: { scale: 3, useCORS: true },
      jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' }
    };

    // This command triggers a direct download
    html2pdf().set(options).from(element).save();
  }

  document.addEventListener('DOMContentLoaded', function() {
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('placed') === 'true') {
        setTimeout(function() {
            const btn = document.getElementById('whatsappBtn');
            if(btn) btn.click();
        }, 1000); 
    }
  });
</script>

{% endblock %}
